# AEGIS Docker Compose - CrewAI + LangFlow Stack
# Version: 2.0.0
# Stack: CrewAI, LangFlow, FastAPI, Redis, ChromaDB

version: '3.8'

services:
  # ===========================================================================
  # AEGIS API Server (FastAPI + CrewAI)
  # ===========================================================================
  aegis-api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: aegis-api
    ports:
      - "8000:8000"
    environment:
      # LLM Configuration
      - LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # ServiceNow
      - SERVICENOW_INSTANCE=${SERVICENOW_INSTANCE}
      - SERVICENOW_USER=${SERVICENOW_USER}
      - SERVICENOW_PASSWORD=${SERVICENOW_PASSWORD}

      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # RAG Service
      - RAG_SERVICE_URL=http://rag-service:8100

      # Teams
      - TEAMS_WEBHOOK_URL=${TEAMS_WEBHOOK_URL}
    depends_on:
      - redis
      - rag-service
    networks:
      - aegis-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # LangFlow Visual Pipeline Builder
  # ===========================================================================
  langflow:
    image: langflowai/langflow:latest
    container_name: aegis-langflow
    ports:
      - "7860:7860"
    environment:
      - LANGFLOW_DATABASE_URL=sqlite:///./langflow.db
      - LANGFLOW_SUPERUSER=admin
      - LANGFLOW_SUPERUSER_PASSWORD=${LANGFLOW_PASSWORD:-aegis2026}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - langflow-data:/app/langflow
      - ./langflow/flows:/app/flows
    networks:
      - aegis-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:7860/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # RAG Service (FastAPI + ChromaDB + Bedrock)
  # ===========================================================================
  rag-service:
    build:
      context: ./rag-service
      dockerfile: Dockerfile
    container_name: aegis-rag
    ports:
      - "8100:8100"
    environment:
      # AWS Bedrock
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
      - AWS_EMBEDDING_MODEL=amazon.titan-embed-text-v2:0

      # LLM
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # ChromaDB
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8200
    depends_on:
      - chromadb
    networks:
      - aegis-network
    restart: unless-stopped

  # ===========================================================================
  # ChromaDB Vector Database
  # ===========================================================================
  chromadb:
    image: chromadb/chroma:latest
    container_name: aegis-chromadb
    ports:
      - "8200:8000"
    volumes:
      - chroma-data:/chroma/chroma
    environment:
      - ANONYMIZED_TELEMETRY=false
      - ALLOW_RESET=true
    networks:
      - aegis-network
    restart: unless-stopped

  # ===========================================================================
  # Redis Stack (Governance, Caching, Storm Shield)
  # ===========================================================================
  redis:
    image: redis/redis-stack:latest
    container_name: aegis-redis
    ports:
      - "6379:6379" # Redis
      - "8001:8001" # RedisInsight
    volumes:
      - redis-data:/data
      - ./docker/redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-stack-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      - aegis-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Redis Initialization (Run once)
  # ===========================================================================
  redis-init:
    image: redis:alpine
    container_name: aegis-redis-init
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - aegis-network
    entrypoint: >
      sh -c "
        echo 'Initializing Redis governance keys...'
        redis-cli -h redis SET gov:killswitch true
        redis-cli -h redis SET gov:mode assist
        redis-cli -h redis SET gov:threshold:auto_assign 85
        redis-cli -h redis SET gov:threshold:auto_categorize 80
        redis-cli -h redis SET gov:threshold:auto_remediate 95
        echo 'Redis initialization complete!'
      "
    restart: "no"

  # ===========================================================================
  # Admin Portal (React + Vite)
  # ===========================================================================
  admin-portal:
    build:
      context: ./admin-portal
      dockerfile: Dockerfile
    container_name: aegis-admin
    ports:
      - "3000:80"
    depends_on:
      - aegis-api
    networks:
      - aegis-network
    restart: unless-stopped

  # ===========================================================================
  # Triage Worker (LangGraph Pipeline)
  # ===========================================================================
  aegis-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: aegis-worker
    command: python workers/triage_worker.py
    environment:
      # LLM Configuration
      - LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # ServiceNow
      - SERVICENOW_INSTANCE=${SERVICENOW_INSTANCE}
      - SERVICENOW_USER=${SERVICENOW_USER}
      - SERVICENOW_PASSWORD=${SERVICENOW_PASSWORD}

      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # RAG Service
      - RAG_SERVICE_URL=http://rag-service:8100

      # Teams
      - TEAMS_WEBHOOK_URL=${TEAMS_WEBHOOK_URL}
    depends_on:
      - redis
      - rag-service
    networks:
      - aegis-network
    restart: unless-stopped
    deploy:
      replicas: 2 # Run 2 workers for parallel processing
    volumes:
      - /var/log/aegis:/var/log/aegis

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  aegis-network:
    driver: bridge
    name: aegis-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  redis-data:
    name: aegis-redis-data
  chroma-data:
    name: aegis-chroma-data
  langflow-data:
    name: aegis-langflow-data
