# AEGIS Docker Compose - LangGraph Pipeline Stack
# Version: 2.1.0
# Stack: FastAPI, LangGraph, Redis, ChromaDB, Admin Portal
#
# Usage: docker-compose up -d (run from this directory)

services:
  # ===========================================================================
  # AEGIS API Server (FastAPI + LangGraph)
  # ===========================================================================
  aegis-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: aegis-api
    ports:
      - "8080:8000" # Host:Container
    environment:
      # AWS Bedrock Configuration
      - AWS_BEARER_TOKEN_BEDROCK=${AWS_BEARER_TOKEN_BEDROCK}
      - BEDROCK_CLAUDE_SONNET_MODEL=${BEDROCK_CLAUDE_SONNET_MODEL:-anthropic.claude-3-5-sonnet-20241022-v2:0}
      - AWS_TITAN_EMBEDDING_MODEL=${AWS_TITAN_EMBEDDING_MODEL:-amazon.titan-embed-text-v2:0}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}

      # ServiceNow
      - SERVICENOW_INSTANCE=${SERVICENOW_INSTANCE}
      - SERVICENOW_USER=${SERVICENOW_USER}
      - SERVICENOW_PASSWORD=${SERVICENOW_PASSWORD}

      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # RAG Service
      - RAG_SERVICE_URL=http://rag-service:8000

      # Teams
      - TEAMS_WEBHOOK_URL=${TEAMS_WEBHOOK_URL}
    depends_on:
      - redis
      - rag-service
    networks:
      - aegis-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Triage Worker (LangGraph Pipeline)
  # ===========================================================================
  aegis-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    command: python workers/triage_worker.py
    environment:
      # AWS Bedrock Configuration
      - AWS_BEARER_TOKEN_BEDROCK=${AWS_BEARER_TOKEN_BEDROCK}
      - BEDROCK_CLAUDE_SONNET_MODEL=${BEDROCK_CLAUDE_SONNET_MODEL:-anthropic.claude-3-5-sonnet-20241022-v2:0}
      - AWS_TITAN_EMBEDDING_MODEL=${AWS_TITAN_EMBEDDING_MODEL:-amazon.titan-embed-text-v2:0}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}

      # ServiceNow
      - SERVICENOW_INSTANCE=${SERVICENOW_INSTANCE}
      - SERVICENOW_USER=${SERVICENOW_USER}
      - SERVICENOW_PASSWORD=${SERVICENOW_PASSWORD}

      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # RAG Service
      - RAG_SERVICE_URL=http://rag-service:8000

      # Teams
      - TEAMS_WEBHOOK_URL=${TEAMS_WEBHOOK_URL}
    depends_on:
      - redis
      - rag-service
    networks:
      - aegis-network
    restart: unless-stopped
    healthcheck:
      disable: true
    deploy:
      replicas: 2
    volumes:
      - /var/log/aegis:/var/log/aegis

  # ===========================================================================
  # RAG Service (FastAPI + Redis + Bedrock)
  # ===========================================================================
  rag-service:
    build:
      context: ../rag-service
      dockerfile: Dockerfile
    container_name: aegis-rag
    ports:
      - "8100:8000"
    environment:
      # AWS Bedrock Configuration
      - AWS_BEARER_TOKEN_BEDROCK=${AWS_BEARER_TOKEN_BEDROCK}
      - BEDROCK_CLAUDE_SONNET_MODEL=${BEDROCK_CLAUDE_SONNET_MODEL:-anthropic.claude-3-5-sonnet-20241022-v2:0}
      - AWS_TITAN_EMBEDDING_MODEL=${AWS_TITAN_EMBEDDING_MODEL:-amazon.titan-embed-text-v2:0}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}

      # Redis Vector DB
      - REDIS_URL=redis://redis:6379

    depends_on:
      redis:
        condition: service_healthy
    networks:
      - aegis-network
    restart: unless-stopped

  # ===========================================================================
  # Redis Stack (Governance, Queue, Storm Shield)
  # ===========================================================================
  redis:
    image: redis/redis-stack:latest
    container_name: aegis-redis
    ports:
      - "6379:6379"
      - "8501:8001" # RedisInsight
    volumes:
      - redis-data:/var/lib/redis-stack
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-stack-server", "/usr/local/etc/redis/redis.conf" ]
    networks:
      - aegis-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Redis Initialization (Run once)
  # ===========================================================================
  redis-init:
    image: redis:alpine
    container_name: aegis-redis-init
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - aegis-network
    entrypoint: >
      sh -c "
        echo 'Initializing Redis governance keys...'
        redis-cli -h redis SET gov:killswitch true NX
        redis-cli -h redis SET gov:mode assist NX
        redis-cli -h redis SET gov:threshold:auto_assign 85 NX
        redis-cli -h redis SET gov:threshold:auto_categorize 80 NX
        redis-cli -h redis SET gov:threshold:auto_remediate 95 NX
        echo 'Initializing Redis queue...'
        redis-cli -h redis PING
        echo 'Redis initialization complete!'
      "
    restart: "no"

  # ===========================================================================
  # Admin Portal (React + Vite)
  # ===========================================================================
  admin-portal:
    build:
      context: ../admin-portal
      dockerfile: Dockerfile
    container_name: aegis-admin
    ports:
      - "3000:80"
    depends_on:
      - aegis-api
    networks:
      - aegis-network
    restart: unless-stopped

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  aegis-network:
    driver: bridge
    name: aegis-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  redis-data:
    name: aegis-redis-data
